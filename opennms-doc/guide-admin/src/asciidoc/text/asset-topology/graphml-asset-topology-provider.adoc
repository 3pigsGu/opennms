
// Allow GitHub image rendering
:imagesdir: ../../images

=== Overview

_{opennms-product-name}_ has introduced the ability for users to define arbitrarily complex
 layered topologies using GraphML (see http://graphml.graphdrawing.org/). 
 The details of how _{opennms-product-name}_ interprets GraphML are given in the 
 GraphML section of the _{opennms-product-name}_ developers guide. The ability to display 
 complex layered topologies is a great feature but creating a usable GraphML topology for a 
 large network can be a complex task for a user. 

The _Asset Topology Provider_ avoids the need for users to work directly with GraphML 
by directly generating a layered GraphML topology based upon node parameters and the contents of the Node Asset table.
 The _Asset Topology Provider_ greatly simplifies the task for many use cases by allowing users 
 to define fields in the Node Asset table which will enable nodes to be positioned correctly
  in a complex topology. This allows a physical and logical ordering of nodes which makes 
  it easier for users to represent and navigate their infrastructure.

The structure of the generated topology is determined by the `assetLayers` configuration 
constant which can be set by a user. To illustrate how this works, we will consider the following configuration:
----
assetLayers=asset-region,asset-building
----
The _{opennms-product-name}_ Asset table is parsed to generate nested layers in 
the order of the comma separated keys in the assetLayers property. 
Each layer is a graph which is named after the key. Graph nodes in each layer reference 
related Graph nodes in the underlying layer. The lowest layer contains Graph nodes which 
are directly linked to monitored _{opennms-product-name}_ nodes which have entries in the Asset table.

The following diagram shows the structure of a topology generated by the above `assetLayers` property

image:asset-topology/graphMLtopologyLayers.jpg[Illustrating how node asset entries are interpreted as layers]

In this example the `region` asset fields for node 1,2,3,4 are set to north. 
All of these nodes are in the same north region. The `building` asset fields 
for Node 1 and Node 2 are set to 21 (both nodes are in building 21) while the 
`building` asset fields for Node 3 and Node 4 are set to 22 (both nodes are in building 22). 

The _Asset Topology Provider_ generates four linked graphs for this configuration. 
The layer 0 graph is called `asset-region`, the layer 1 graph is called `asset-building` 
and the layer 2 graph is called `nodes`. 

Conceptually we can see that the topology is rendered as concentric sets. 
The _Asset Topology Provider_ first searches all of the nodes with regions 
defined and creates a new level 0 graph node representing each region found. 
The _Asset Topology Provider_ then searches within each region to find the building entries and 
creates a corresponding level 1 graph node for each building name found. Finally the _Asset Topology Provider_ 
creates layer 2 nodes corresponding to each _{opennms-product-name}_ monitored node and places each in the correct building. 

If however _{opennms-product-name}_ monitored nodes are found which have either the region 
or building asset fields empty they cannot be placed correctly in this topology. 
These nodes as shown in the diagram as `unallocated nodes`. 
Finally, only building and region nodes are generated which can be linked to _{opennms-product-name}_ nodes in the topology. 
The _Asset Topology Provider_ does not generate spurious graph nodes in upper 
layers which are not directly and completely referenced by _{opennms-product-name}_ nodes in the lowest layer.

Example screenshots of a topology containing regions, buildings, racks and nodes are shown below

image::asset-topology/AssetScreen1.png[Screenshot of Regions Layer,400,600]

image::asset-topology/AssetScreen2.png[Screenshot of Buildings Layer,400,600]

image::asset-topology/AssetScreen3.png[Screenshot of Nodes Layer,400,600]

=== Asset layers
The entries for `assetLayers` can be any node or asset entry from the following list (defined in class NodeParamLabels). 
----
node-nodelabel, node-nodeid, node-foreignsource, node-foreignid, node-nodesysname, 
node-nodesyslocation, node-operatingsystem, node-categories, 
parent-nodelabel, parent-nodeid, parent-foreignsource, parent-foreignid, 
asset-country, asset-address1, asset-address2, asset-city, asset-zip, asset-state, 
asset-latitude, asset-longitude, asset-region, asset-division, 
asset-department, asset-building, asset-floor, asset-room, 
asset-rack, asset-slot, asset-port, asset-circuitid, 
asset-category, asset-displaycategory, asset-notifycategory, 
asset-pollercategory, asset-thresholdcategory, asset-managedobjecttype, 
asset-managedobjectinstance, asset-manufacturer, asset-vendor, 
asset-modelnumber, asset-description, asset-operatingsystem
----
This allows arbitrary topologies to be generated including physical fields (room, rack etc.) and 
logical fields such as asset node categories. Please note you should not put any spaces in the comma separated `assetLayers` list. 
If the `assetLayers` property is defined as empty then a single graph layer will be generated containing all opennms nodes.

=== Node filtering
In many cases it is desirable to control which nodes are included or excluded from a topology. For instance it is
useful to be able to generate customised topologies for specific customers which include only regions/sites etc 
relevant to their filtered node set. To this end it is possible to define a node filter 
which chooses which nodes are included in a generated topology.

Filters are defined using the same asset table keys which are available for the `assetLayers` field. 

[options="header, autowidth"]
|===
| Operation  | Definition  | Example
| OR | key1=value1,value2 alternatively key1=value1&key1=value2 | asset-region=north,south
| AND | key1=val1&key2=val2 | asset-region=north&asset-site=23
| NOT | key1=!val1 | asset-site=!23
|===

Thus the following configuration means include only nodes with region `north` or `south` but exclude all nodes with site `23`.
----
filter=asset-region=north,south&asset-site=!23
----

The filters are designed to treat all selected text key entries as comma separated values (csv). This allows OpenNMS node-categories which are
many to many entries to be dealt with as a comma separated list of values; routers,servers,web etc. 
Thus we can select based on multiple separate node categories. The following configuration means show routers and servers on all sites except site 23.

----
filter=node-categories=routers,servers&asset-site=!23
----

The filters treat all asset table entries as comma seperated variables (csv). This also means that, 
for instance asset-displaycategory could also contain several values separated by commas. e.g. customer1,customer2,customer3 etc.

NOTE: You should make sure asset addresses and other free format asset text fields do not contain commas if you want an exact match on the whole field

Regular expressions are also allowed. Regular expressions start with the ~ character. 
You can also negate a regular expression by preceding it with !~.

The following example will match against regions 'Stuttgart' and 'Isengard' and any site name which ends in 4
----
filter=asset-region=~.*gar(t|d)&asset-site=~.*4
----

=== Configuration
The default configuration for the Asset Topology Provider is held in the following file:
----
<opennms home>/etc/org.opennms.plugins.graphml.asset.cfg
----
Which contains the following properties (defaults shown will be used if the file is not present)

[options="header, autowidth"]
|===
| Parameter                 | Default               | Description
|`providerId` | asset | The unique name of the provider - used as handle to install and remove the topology
|`label` | Asset Provider | The name which shows up on the topology menu (must be unique)
|`assetLayers`| asset-region,asset-building,asset-rack  | asset layers (in order). See separate description.
|`filter` | '' | Empty filter (i.e. allow all nodes). See separate description.
|`preferredLayout` | 'Grid Layout' | Preferred layout of the nodes in generated graphs. 
|`breadcrumbStrategy` | SHORTEST_PATH_TO_ROOT | Breadcrumb strategy used to display breadcrumbs above each graph
|===

Any of these default properties can be changed when a command is given to generate an asset topology.

=== Creating Asset Based Topologies From Karaf Consol

The _{opennms-product-name}_ Karaf Consol can be used to control topology generation. To login use admin password.
----
ssh admin@localhost -p 8101
----
The following commands are available

[options="header, autowidth"]
|===
| Command                      | Description               | Options
| asset-topology:create        | Creates Asset Topology.   | 

-l, --label : Asset Topology label (shows in topology menu)

-i, --providerId : Unique providerId of asset topology

-f, --filter : Optional node filter

-a, --assetLayers : Comma separated list of asset layers

-p, --preferredLayout : Preferred Layout

-b, --breadcrumbStrategy : Bread Crumb Strategy

| asset-topology:remove        | Removes Asset Topology.   | 
-i, --providerId : Unique providerId of asset topology

|===

Any debug data is created in <opennms home>/data/tmp/AssetListFile.xml containing all the nodes and associated asset fields.
 (This file can be used for debugging. A similar file is used in the unit tests for this module).

=== Creating Asset Based Topologies Using _{opennms-product-name}_ events

The _Asset Topology Provider_ listens for events which trigger the generation and installation or removal of topologies. 
The _Asset Topology Provider_ events are defined in the file
----
<opennms home>/etc/events/GraphMLAssetPluginEvents.xml
----

These events will use the default parameters 

To create a new topology from the current OpenNMS inventory use 
----
sudo ./send-event.pl  uei.opennms.plugins/assettopology/create 
----

To uninstall an asset topology use
----
sudo ./send-event.pl  uei.opennms.plugins/assettopology/remove
----


=== Viewing the topology
If all goes well, having installed the topology, upon refreshing your screen, 
you should see a new topology display option in the _{opennms-product-name}_  topology page. 
The displayed name of this topology is given by the label field

It is not related to the name of the topology (topologyName) which is used by the ReST api for the installation or removal of a topology. However this name must be unique across all installed topologies. 

It is possible to have several topologies installed which have been generated using different configurations.
You simply need to ensure that the providerId used for each installation command is different.

=== additional notes

Please note you MUST first uninstall an _{opennms-product-name}_ graphml topology before installing a new one. 
You will also have to log out and log back into the UI in order to see the new topology file. 
If you uninstall a topology while viewing it, the UI will throw an error and 
you will also have to log out and back in to see topologies. 

