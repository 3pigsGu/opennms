<?xml version="1.0" encoding="utf-8"?>
<chapter id="chap2" label="2.">
	<title>What's New?</title>
	<subtitle>Changes in This OpenNMS</subtitle>
	<para>
		OpenNMS 1.1.0 represents a refinement of the functionality introduced in 1.0.0.
	</para>
        <sect1 id="chap2sect1" label="2.1.">
                <title>Changes in OpenNMS 1.1.1 and Above</title>
                <para>
                        The following features were added in 1.1.1:
                        <itemizedlist>
                                <listitem>
                                        <formalpara>
                                                <title>Trap Handling</title>
						<para>
							SNMP Traps will now be associated with nodes if the IP address
							in the trap matches a known IP address in the database.
						</para>
						<para>
							If the IP Address is not known, OpenNMS will generate a 
							newSuspect event to attempt to discover the device. This
							behavior can be disabled in the trapd-configuration.xml
							file. 
						</para>
						<para>
							Added new trap definitions for Dell OpenManage, Foundry
							Networks and ADIC. Also added an updated mib2opennms
							program which improves the look of the output.
						</para>
                                        </formalpara>
                                        <formalpara>
                                                <title>Reports</title>
						<para>
							Added a new custom reporting module which allows one to
							create and save custom performance reports. It is called
							the Key SNMP Custom (KSC) Reporting Tool.
						</para>
						<para>
							Added buttons on the standard Performance and Response
							Time pages to allow the range to be changed between
							the last Day/Week/Month/Year.
						</para>
                                        </formalpara>
                                        <formalpara>
                                                <title>Response Time</title>
						<para>
							Added the ability to collect response time on the following
							pollers: Citrix, FTP, HTTPS, IMAP, POP3, SMTP and TCP.
						</para>
						<para>
							The RRAs for Response Time data are now part of the 
							poller configuration file.
						</para>
                                        </formalpara>
                                        <formalpara>
                                                <title>Web Improvements</title>
						<para>
							There is now a Response Time link on the node and
							interface pages.
						</para>
						<para>
							If a node or interface supports HTTP, there is now a link
							to that service.
						</para>
						<para>
							Added a two minute refresh to the event listing page.
						</para>
                                        </formalpara>
                                        <formalpara>
                                                <title>Other Features</title>
						<para>
							Added non-blocking I/O to the HTTPS service. Now all monitors
							and plug-ins should be non-blocking.
						</para>
						<para>
							If you set the IP Address in a poll-outages calendar to 
							"match-any" it will match all addresses in the poller
							package that uses that calendar.
						</para>
						<para>
							Increased the size of the contactinfo field in the 
							usersnotified table, and changed create.sql to make
							this easier.
						</para>
                                        </formalpara>
                                        <formalpara>
                                                <title>Fixed Bugs</title>
						<para>
							Fixed numerous bugs, including 650 where "down" events
							could be written to the database after the corresponding
							"up" event. See the CHANGELOG for a full list.
						</para>
                                        </formalpara>
                                        <formalpara>
                                                <title>Tomcat4</title>
						<para>
							For a variety of reasons, OpenNMS 1.1.1 and beyond will
							require Tomcat4 version 4.1.10 or higher.
						</para>
                                        </formalpara>
				</listitem>
			</itemizedlist>
		</para>
	</sect1>
        <sect1 id="chap2sect2" label="2.2.">
                <title>Changes in OpenNMS 1.1.0 and Above</title>
                <para>
                        There were many changes to OpenNMS between 1.0 and 1.1. Here are a few listed by functional area.
                        <itemizedlist>
                                <listitem>
                                        <formalpara>
                                                <title>Events and Event Handling</title>
						<para>
							The events and notifications part of OpenNMS saw the most
							changes with 1.1.0. First, there was a new tag added to
							the <filename>eventconf.xml</filename> file called
							&lt;event-file&gt;. This allows for external files to be
							included in the event configuration.
						</para>
						<para>
							Also, the order in which events appear is now strictly enforced.
							When trying to match an event with an event definition, OpenNMS
							takes the first match. The events in the <filename>eventconf.xml</filename>
							are read first, followed by the files identified by &lt;event-file&gt;
							tags (in the order in which they are listed). In the configuration
							that ships with OpenNMS, the file with the default events is loaded
							last. Be sure to add any custom files before that one.
						</para>
						<para>
							Prior to this release, the SNMP generic traps 0-5 (coldStart, warmStart,
							linkDown, etc.) were hard-coded. Now they must be defined (and that
							definition is included in the default events file), but this allows
							for generic traps other than type 6 to be configured differently for,
							say, different hosts.
						</para>
						<para>
							Speaking of event files, over 2750 events were added out of the box,
							including those from vendors such as Cisco, HP and 3Com. Please
							let us know if anything is misconfigured or if we need to add 
							some events.
						</para>
						<para>
							The ability to configure events based on parameters (varbinds) was
							also added. This is best demonstrated with an example. In the new
							HP event definitions there is an event called hpicfFaultFinderTrap.
							It is defined as:
<programlisting>
&lt;event&gt;
 &lt;mask&gt;
  &lt;maskelement&gt;
   &lt;mename&gt;id&lt;/mename&gt;
   &lt;mevalue&gt;.1.3.6.1.4.1.11.2.14.12.1&lt;/mevalue&gt;
  &lt;/maskelement&gt;
  &lt;maskelement&gt;
   &lt;mename&gt;generic&lt;/mename&gt;
   &lt;mevalue&gt;6&lt;/mevalue&gt;
  &lt;/maskelement&gt;
  &lt;maskelement&gt;
   &lt;mename&gt;specific&lt;/mename&gt;
   &lt;mevalue&gt;5&lt;/mevalue&gt;
  &lt;/maskelement&gt;
 &lt;/mask&gt;
 &lt;uei&gt;uei.opennms.org/vendor/HP/traps/hpicfFaultFinderTrap&lt;/uei&gt;
 &lt;event-label&gt;HP-ICF-FAULT-FINDER-MIB defined trap event: hpicfFaultFinderTrap&lt;/event-label&gt;
 &lt;descr&gt;&lt;p&gt;This notification is sent whenever the Fault
 Finder creates an entry in the hpicfFfLogTable.&lt;/p&gt;&lt;table&gt;
 &lt;tr&gt;&lt;td&gt;&lt;b&gt;
 hpicfFfLogFaultType&lt;/b&gt;&lt;/td&gt;&lt;td&gt;%parm[#1]%
 &lt;/td&gt;&lt;td&gt;&lt;p;&gt;
 badDriver(1) badXcvr(2) badCable(3) tooLongCable(4) overBandwidth(5) bcastStorm(6) partition(7)
 misconfiguredSQE(8) polarityReversal(9) networkLoop(10) lossOfLink(11) portSecurityViolation(12)
 backupLinkTransition(13) meshingFault(14) fanFault(15) rpsFault(16) stuck10MbFault(17) lossOfStackMember(18)
 hotSwapReboot(19)
 &lt;/p&gt;&lt;/td;&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;b&gt;
 hpicfFfLogAction&lt;/b&gt;&lt;/td&gt;&lt;td&gt;%parm[#2]%
 &lt;/td&gt;&lt;td&gt;&lt;p;&gt;
 none(1) warn(2) warnAndDisable(3) warnAndSpeedReduce(4) warnAndSpeedReduceAndDisable(5)
 &lt;/p&gt;&lt;/td;&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;b&gt;
 hpicfFfLogSeverity&lt;/b&gt;&lt;/td&gt;&lt;td&gt;%parm[#3]%
 &lt;/td&gt;&lt;td&gt;&lt;p;&gt;
 informational(1) medium(2) critical(3)
 &lt;/p&gt;&lt;/td;&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;b&gt;
 hpicfFfFaultInfoURL&lt;/b&gt;&lt;/td&gt;&lt;td&gt;%parm[#4]%
 &lt;/td&gt;&lt;td&gt;&lt;p;&gt;&lt;/p&gt;&lt;/td;&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;/descr&gt;
 &lt;logmsg dest='logndisplay'&gt;&lt;p&gt;HP Event: ICF Hub Fault Found.&lt;/p&gt;&lt;/logmsg&gt;
 &lt;severity&gt;Warning&lt;/severity&gt;
&lt;/event&gt;
</programlisting>
						</para>
						<para>
							Note that the third parameter denotes the severity of the event. By
							default this event has a severity of Warning, but what if it was desired to make the
							"critical" event a severity of Major? Using the new varbind extension to
							the mask tag:
<programlisting>
&lt;event&gt;
 &lt;mask&gt;
  &lt;maskelement&gt;
   &lt;mename&gt;id&lt;/mename&gt;
   &lt;mevalue&gt;.1.3.6.1.4.1.11.2.14.12.1&lt;/mevalue&gt;
  &lt;/maskelement&gt;
  &lt;maskelement&gt;
   &lt;mename&gt;generic&lt;/mename&gt;
   &lt;mevalue&gt;6&lt;/mevalue&gt;
  &lt;/maskelement&gt;
  &lt;maskelement&gt;
   &lt;mename&gt;specific&lt;/mename&gt;
   &lt;mevalue&gt;5&lt;/mevalue&gt;
  &lt;/maskelement&gt;
  &lt;varbind&gt;
   &lt;vbnumber&gt;specific&lt;/vbnumber&gt;
   &lt;vbvalue&gt;5&lt;/vbvalue&gt;
  &lt;/varbind&gt;
 &lt;/mask&gt;
 &lt;uei&gt;uei.opennms.org/vendor/HP/traps/hpicfFaultFinderTrap&lt;/uei&gt;
 &lt;event-label&gt;HP-ICF-FAULT-FINDER-MIB defined trap event: hpicfFaultFinderTrap&lt;/event-label&gt;
 &lt;descr&gt;&lt;p&gt;This notification is sent whenever the Fault
 Finder creates an entry in the hpicfFfLogTable.&lt;/p&gt;&lt;table&gt;
 &lt;tr&gt;&lt;td&gt;&lt;b&gt;
 hpicfFfLogFaultType&lt;/b&gt;&lt;/td&gt;&lt;td&gt;%parm[#1]%
 &lt;/td&gt;&lt;td&gt;&lt;p;&gt;
 badDriver(1) badXcvr(2) badCable(3) tooLongCable(4) overBandwidth(5) bcastStorm(6) partition(7)
 misconfiguredSQE(8) polarityReversal(9) networkLoop(10) lossOfLink(11) portSecurityViolation(12)
 backupLinkTransition(13) meshingFault(14) fanFault(15) rpsFault(16) stuck10MbFault(17) lossOfStackMember(18)
 hotSwapReboot(19)
 &lt;/p&gt;&lt;/td;&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;b&gt;
 hpicfFfLogAction&lt;/b&gt;&lt;/td&gt;&lt;td&gt;%parm[#2]%
 &lt;/td&gt;&lt;td&gt;&lt;p;&gt;
 none(1) warn(2) warnAndDisable(3) warnAndSpeedReduce(4) warnAndSpeedReduceAndDisable(5)
 &lt;/p&gt;&lt;/td;&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;b&gt;
 hpicfFfLogSeverity&lt;/b&gt;&lt;/td&gt;&lt;td&gt;%parm[#3]%
 &lt;/td&gt;&lt;td&gt;&lt;p;&gt;
 informational(1) medium(2) critical(3)
 &lt;/p&gt;&lt;/td;&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;b&gt;
 hpicfFfFaultInfoURL&lt;/b&gt;&lt;/td&gt;&lt;td&gt;%parm[#4]%
 &lt;/td&gt;&lt;td&gt;&lt;p;&gt;&lt;/p&gt;&lt;/td;&gt;&lt;/tr&gt;&lt;/table&gt;
 &lt;/descr&gt;
 &lt;logmsg dest='logndisplay'&gt;&lt;p&gt;HP Event: ICF Hub Fault Found.&lt;/p&gt;&lt;/logmsg&gt;
 &lt;severity&gt;Major&lt;/severity&gt;
&lt;/event&gt;
</programlisting>
						</para>
						<para>
							This event, when added before the previous event since it is more
							specific, will try to match on the enterprise id, the generic trap
							value of 6, the specific trap value of 5 <emphasis>and</emphasis> the
							value of the third parameter, or varbind, of 3.
						</para>
						<para>
							There was also the addition of a low and high threshold rearm events.
							When a threshold is exceeded in consecutive polls equal to the trigger
							number, the threshold event is generated. Another event will not be 
							generated until the polled value drops below the rearm number. The
							rearm event is thus similar to a "cleared" event. Since the first 
							parameter passed with the threshold event is the data source name, using
							the "varbind" tag above, each data source can now have its own event.
						</para>
						<para>
							One of the more noticeable changes is that the Unique Event Identifier
							no longer contains "http://". The original intent was that the UEI would
							act something like an XML namespace, but in practice it is just a label,
							so the "http://" was removed to avoid confusion.
						</para>
						<para>
							Notifications also received some attention with this release. Due to 
							popular demand, the tags %nodelabel% and %interfaceresolve% are now
							available. The former will display the label of the nodeid associated
							with the event, and the latter will attempt to resolve the name
							associated with the IP Address of the interface of the event.
						</para>
						<para>
							In <filename>notifd-configuration.xml</filename> there are now two
							new attributes. In the global properties, there is "match-all". By
							default, this is set to false, which means that the first notification
							that matches an event will be the only notification sent. If it is set
							to true, then all notifications that match a given event will be sent. (Thanks Nick)
							In the auto-acknowledge section, there is a new attribute called "clear".
							By adding "clear=true" to the auto-acknowledge tag, both the event
							being auto acknowledged <emphasis>and</emphasis> the event that caused
							the acknowledgement will be acknowledged. Thus the "up" event that clears 
							a "down" will also be cleared.
						</para>
						<para>
							In addition to these enhancements, various bugs were fixed. Notification
							rules now actually work, and you can filter node level events via IP
							address. Also, threshold events can now generate notifications.
						</para>
                                        </formalpara>
                                </listitem>
                                <listitem>
                                        <formalpara>
                                                <title>Polling</title>
						<para>
							The biggest change to polling would have to be the addition of response
							time information for DHCP, DNS, HTTP and ICMP based pollers. Similar
							to data collection, the response time information can be graphed and
							it can have threshold alarms placed on it.
						</para>
						<para>
							Also, all of the plugins and monitors (except HTTPS) have been re-written
							to use the non-blocking I/O available in the 1.4 JDK. 
						</para>
                                        </formalpara>
                                </listitem>
                                <listitem>
                                        <formalpara>
                                                <title>Discovery</title>
                                                <para>
							There has been some discussion on how OpenNMS determines node labels. 
							Currently, this is set to the resolved SNMP Primary Interface IP Address.
							However, it is common practice on routers to have a software-loopback
							address. OpenNMS will now discover such interfaces (as long as they do
							not have an address that starts with 127) and mark them as the primary
							SNMP Interface. Note that no services will be polled on such interfaces.
						</para>
                                        </formalpara>
                                </listitem>
                                <listitem>
                                        <formalpara>
                                                <title>The Web User Interface</title>
                                                <para>
							A few changes were made to the WebUI. There is now a webui-colors.xml file
							that will allow for dynamic changes to the background colors used in the
							categories list on the main page (more pages to follow). Also under "Admin"
							the ability to delete nodes was added.
						</para>
						<para>
							In addition, there is a new Admin page that will allow one to choose which
							non-IP interfaces will be used in data collection. By setting the snmpStorageFlag
							in <filename>datacollection-config.xml</filename> to "select" (now the default),
							OpenNMS will only store data from those interfaces that could serve as a primary
							SNMP interface. One can then select which other interfaces to collect on using
							the GUI. The previous values of snmpStorageFlag ("primary" and "all") still work.
						</para>
						<para>
							Also, the "Destination Path" interface now has the ability to choose NOT to 
							include a service (thanks Nick) which will create a rule like "match the events where service is NOT FTP",
							and by placing the mouse over the categories on the main page, the last time
							the category was updated should be displayed.
						</para>
                                        </formalpara>
                                </listitem>
                                <listitem>
                                        <formalpara>
                                                <title>Fixed Service Deletion in Downtime Model</title>
                                                <para>
							The poller downtime model allows for a service to be
							deleted if it has been down for a certain amount of
							time. This did not work correctly and has been fixed.
                                                </para>
                                        </formalpara>
                                </listitem>
                                <listitem>
                                        <formalpara>
                                                <title>Reduced the Amount of Data Initially Collected from the ifTable</title>
                                                <para>
                                                        During discovery, the ifTable is collected from each device
							that is found to support SNMP. On some HP switches, this
							would fail due to a limitation on the SNMP maximum packet size.
							All non-essential ifTable elements were removed from the request
							that appears to resolve the problem.
                                                </para>
                                        </formalpara>
                                </listitem>
                                <listitem>
                                        <formalpara>
                                                <title>Removed Spaces in Notification Path Names</title>
                                                <para>
                                                        Spaces in Notification Path names have been known to
							cause problems. The Web UI was modified to disallow
							spaces in path names. Bug 657.
                                                </para>
                                        </formalpara>
                                </listitem>
                                <listitem>
                                        <formalpara>
                                                <title>Fixed the AM/PM Ordering on Performance Report UI.</title>
                                                <para>
							In the Custom Performance Report Web UI, 11 PM was
							followed by 12 PM, when it should have been 12 AM. This
							has been corrected. Bug 515.
                                                </para>
                                        </formalpara>
                                </listitem>
                                <listitem>
                                        <formalpara>
                                                <title>Added a "contrib" Directory</title>
                                                <para>
							The "contrib" directory now contains code, such as nifty
							utilities, that exists outside of the main OpenNMS source
							but may prove useful. One such example is Tomas Carlsson's
							"mib2opennms" program. These programs are not supported.
                                                </para>
                                        </formalpara>
                                </listitem>
                                <listitem>
                                        <formalpara>
                                                <title>Removed Duplicate Entries in <filename>capsd-configuration.xml</filename></title>
                                                <para>
							Both LDAP and Citrix protocol plug-ins were listed twice. This
							would slow down the capabilities scan considerably.	
                                                </para>
                                        </formalpara>
                                </listitem>
                                <listitem>
                                        <formalpara>
                                                <title>Updated Data Collection and Graphing</title>
                                                <para>
							Added new entries to <filename>datacollection-config.xml</filename>
							and <filename>snmp-graph.properties</filename>.
                                                </para>
                                        </formalpara>
                                </listitem>
                                <listitem>
                                        <formalpara>
                                                <title>Bugfixes</title>
                                                <para>
                                                        Many bugfixes, including allowing Threshold events to generate
							notifications, AdminStatus and OperStatus values causing
							exceptions, and rescans with certain devices.
                                                </para>
                                        </formalpara>
                                </listitem>
                        </itemizedlist>
                </para>
        </sect1>
	<sect1 id="chap2sect3" label="2.3.">
		<title>Changes in OpenNMS 1.0.0 and Above</title>
		<para>
			The following major changes occurred between 0.9.9 and 1.0.0:
			<itemizedlist>
				<listitem>
					<formalpara>
						<title>OpenSSH service is now "SSH"</title>
						<para>
							The OpenSSH service has been renamed to "SSH" and changed
							to detect common versions of SSH servers other than OpenSSH.
							Upgrades will retain the "OpenSSH" service as well for
							the sake of reports.
						</para>
					</formalpara>
				</listitem>
				<listitem>
					<formalpara>
						<title>"Service Unresponsive" support</title>
						<para>
							There is now the possibility of having a state between
							"up" and "down" that flags a service as being unresponsive.
							This state can be reached when the service's port can be
							connected to, but it doesn't respond in a reasonable amount
							of time.
						</para>
					</formalpara>
				</listitem>
				<listitem>
					<formalpara>
						<title>Bugfixes</title>
						<para>
							Many small bugfixes, including the "Calculating..." problem
							if RTC hasn't come up yet when tomcat starts.
						</para>
					</formalpara>
				</listitem>
			</itemizedlist>
		</para>
	</sect1>
</chapter>
