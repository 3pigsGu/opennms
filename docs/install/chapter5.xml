<?xml version="1.0" encoding="UTF-8"?>
<chapter>
  <title>Building and Installing From Source</title>

  <section>
    <title>Are you sure you want to do this?</title>

    <para>OpenNMS is a complex software product, and it does not (yet) have a
    simple "<code>./configure &amp;&amp; make &amp;&amp; make install</code>"
    build process like many other tools. If there is a packaged release for
    your operating system, we highly suggest you use that instead. If you have
    problems with a packaged release, please see the troubleshooting section
    for assistance.</para>
  </section>

  <section>
    <title>Install prerequisite applications</title>

    <para>See the chaper on installing prerequisites for OpenNMS and install
    all prerequisites.</para>
  </section>

  <section>
    <title>Download source</title>

    <para>You can download source for a specific release, or you can download
    source directly from the source code respository (CVS). You probably want
    to download released source unless you wish to do development or are
    looking for specific features or bug fixes that are not yet in a
    release.</para>

    <section>
      <title>Retrieve released source</title>

      <para>Download the latest source release from the <ulink
      url="http://sourceforge.net/project/showfiles.php?group_id=4141&amp;package_id=118141"><filename>opennms-source</filename>
      file package</ulink> in the <ulink
      url="http://sourceforge.net/project/showfiles.php?group_id=4141">OpenNMS
      files section at SourceForge</ulink>. The file name of the source
      release will look something like
      <filename>opennms-source-@product.version@-@product.release@.tar.gz</filename>.
      After you unarchive the source distribution, change directory into
      <filename>opennms-@product.version@-@product.release@/source</filename>
      and continue to the next section.</para>
    </section>

    <section>
      <title>Retrieve source from CVS</title>

      <para>The source code for OpenNMS is stored in CVS at <ulink
      url="http://sourceforge.net/">SourceForge.net</ulink>. See the <ulink
      url="http://sourceforge.net/cvs/?group_id=4141">OpenNMS CVS page</ulink>
      for details, or follow the instructions below to get started
      quickly.</para>

      <para>Login to the CVS server with an empty password:</para>

      <para><programlisting><computeroutput>$ </computeroutput><command>cvs -d:pserver:anonymous@cvs.sourceforge.net:/cvsroot/opennms login</command></programlisting></para>

      <para>Check out the OpenNMS sources (this will fetch
      <function>HEAD</function>, the most bleeding-edge version):</para>

      <para><programlisting><computeroutput>$ </computeroutput><command>cvs -z3 -d:pserver:anonymous@cvs.sourceforge.net:/cvsroot/opennms co opennms</command></programlisting></para>

      <para>You will now have a directory called <filename>opennms</filename>.
      Change into this directory and continue to the next section.</para>
    </section>
  </section>

  <section>
    <title>Configuring <filename>build.properties</filename></title>

    <para>There are a few details about where RRDtool and PostgreSQL are
    installed that the build process cannot (or does not yet) reliably
    determine automatically. If you don't have RRDtool installed into
    <filename>/usr</filename> or if the PostgreSQL server include directory is
    not <filename>/usr/include/pgsql/server</filename>, you will need to
    create a <filename>build.properties</filename> file.</para>

    <para>You can be lazy and let the build process tell you if it cannot find
    any of these components.</para>

    <para>By default, the install process will install OpenNMS into the
    <filename>dist</filename> directory under the same directory that contains
    <filename>build.xml</filename>. This is fine for testing (and probably
    desireable), but if you want to install into somewhere for production use,
    you need to set <filename>install.dir</filename>. You probably want to add
    a line like this to <filename>build.properties</filename>:</para>

    <para><programlisting>install.dir=/opt/OpenNMS</programlisting></para>
  </section>

  <section>
    <title>Compiling OpenNMS</title>

    <para>This part is easy. Execute this command:</para>

    <para><programlisting><computeroutput>$ </computeroutput><command>./build.sh compile</command></programlisting></para>
  </section>

  <section>
    <title>Installing OpenNMS</title>

    <para>This part is pretty easy, too. Note: this will install into
    <filename>dist</filename> in the same directory as the
    <filename>build.xml</filename>, unless you changed
    <filename>install.dir</filename> as mentioned above. Note that you need to
    be root to install, however you can execute the previous commands as any
    user.</para>

    <para>Execute this command to install:</para>

    <para><programlisting><computeroutput># </computeroutput><command>./build.sh install</command></programlisting></para>

    <para>Once the files are installed, you need execute
    <filename>runjava</filename> to find and configure a suitable Java Runtime
    Environment for OpenNMS and then run the OpenNMS installer to setup the
    database and other items. First, execute <filename>runjava -s</filename>.
    Note that <filename><code>$OPENNMS_HOME</code></filename> is the location
    where OpenNMS is installed. This is the <code>install.dir</code> that was
    set above in your <filename>build.properties</filename> file. You can set
    the environment variable <code>$OPENNMS_HOME</code> in your shell or
    substitute your OpenNMS install location by hand when you execute the
    commands below.</para>

    <para><programlisting><computeroutput># </computeroutput><command>$OPENNMS_HOME/bin/runjava -s</command></programlisting></para>

    <para>Then, execute the installer.</para>

    <para><programlisting><computeroutput># </computeroutput><command>$OPENNMS_HOME/bin/install -disU</command></programlisting></para>
  </section>

  <section>
    <title>Setup the webapp in Tomcat</title>

    <para>The variable <code>$CATALINA_HOME</code> is used below in addition
    to <code>$OPENNMS_HOME</code> which was used above. This should either be
    set as an environment variable to point at the location where you have
    installed Tomcat 4, or you should replace all instances of
    <filename>$CATALINA_HOME</filename> with the location of your Tomcat 4
    installation.</para>

    <section>
      <title>Install <filename>opennms.xml</filename></title>

      <para>Copy the <filename>opennms.xml</filename> Tomcat context file from
      <filename>$OPENNMS_HOME/webapps/opennms.xml</filename> to
      <filename>$CATALINA_HOME/webapps/opennms.xml</filename>.</para>

      <programlisting><computeroutput># </computeroutput><command>cp $OPENNMS_HOME/webapps/opennms.xml $CATALINA_HOME/webapps/opennms.xml</command></programlisting>
    </section>

    <section>
      <title>Create symlinks in <filename>$CATALINA_HOME/server/lib</filename>
      for OpenNMS libraries</title>

      <para>In <filename>$CATALINA_HOME/server/lib</filename> there should be
      a number of symblic links pointing at <code>JAR</code> files in
      <filename>$OPENNMS_HOME/lib</filename>:</para>

      <para><itemizedlist>
          <listitem>
            <para><filename><filename>$CATALINA_HOME/server/lib</filename>/castor-0.9.3.9.jar
            -&gt; $OPENNMS_HOME/lib/castor-0.9.3.9.jar</filename></para>
          </listitem>

          <listitem>
            <para><filename><filename>$CATALINA_HOME/server/lib</filename>/log4j.jar
            -&gt; $OPENNMS_HOME/lib/log4j.jar</filename></para>
          </listitem>

          <listitem>
            <para><filename><filename>$CATALINA_HOME/server/lib/</filename>opennms_common.jar
            -&gt; $OPENNMS_HOME/lib/opennms_common.jar</filename></para>
          </listitem>

          <listitem>
            <para><filename><filename>$CATALINA_HOME/server/lib/</filename>opennms_core.jar
            -&gt; $OPENNMS_HOME/lib/opennms_core.jar</filename></para>
          </listitem>

          <listitem>
            <para><filename><filename><filename>$CATALINA_HOME/server/lib</filename>/opennms_services.jar
            -&gt;
            $OPENNMS_HOME/lib/opennms_services.jar</filename></filename></para>
          </listitem>

          <listitem>
            <para><filename><filename>$CATALINA_HOME/server/lib</filename>/opennms_web.jar
            -&gt; $OPENNMS_HOME/lib/opennms_web.jar</filename></para>
          </listitem>
        </itemizedlist>Here is a short Bourne shell script that will create
      the symbolic links (your current directory needs to be
      <filename>$CATALINA_HOME</filename> when you execute this):</para>

      <programlisting><computeroutput># </computeroutput><command>for JAR in castor-0.9.3.9.jar log4j.jar opennms_common.jar opennms_core.jar opennms_services.jar opennms_web.jar; do</command>
<computeroutput>&gt; </computeroutput><command>    ln -s $OPENNMS_HOME/lib/$JAR $JAR
</command><computeroutput>&gt; </computeroutput><command>done</command></programlisting>
    </section>
  </section>

  <section>
    <title>Starting OpenNMS</title>

    <para>Execute the startup script:</para>

    <para><programlisting><computeroutput># </computeroutput><command>$OPENNMS_HOME/bin/opennms start</command></programlisting></para>
  </section>
</chapter>