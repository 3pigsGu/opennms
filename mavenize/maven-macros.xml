<?xml version="1.0"?>

<project name="maven-macros" default="usage" basedir=".">
	<description>
	Macros to make it easier to convert a project to maven2
  </description>
  
	<taskdef resource="net/sf/antcontrib/antlib.xml">
		<classpath>
			<pathelement location="${opennms.dir}/devlib/ant-contrib.jar" />
		</classpath>
	</taskdef>
	
	<property name="template.dir" value="templates" />
	<property name="module.resources.dir" value="module-resources" />

	<property name="maven.basedir" value="tmp" />

	<property name="java.subdir" value="src/main/java" />
	<property name="test.subdir" value="src/test/java" />
	<property name="castor.subdir" value="src/main/castor" />
	<property name="sablecc.subdir" value="src/main/sablecc" />
	<property name="native.subdir" value="src/main/native" />

	<property name="module.prefix" value="opennms-" />
	<property name="ROOT-groupId" value="org.opennms"/>
	<property name="ROOT-artifactId" value="opennms" />
	<property name="ROOT-version" value="1.3.1-SNAPSHOT" />
	<property name="ROOT-basedir" value="${maven.basedir}"/>

	<macrodef name="stack-init">
		<attribute name="stack-name"/>
		<attribute name="initial-value"/>
		<sequential>
			<var name="@{stack-name}-values" value=""/>
			<var name="@{stack-name}-top" value="@{initial-value}"/>
		</sequential>
	</macrodef>
			
	<macrodef name="stack-push">
		<attribute name="stack-name"/>
		<attribute name="value"/>
		<sequential>
			<var name="@{stack-name}-values" value="${@{stack-name}-top}#${@{stack-name}-values}" />
			<var name="@{stack-name}-top" value="@{value}" />
		</sequential>
	</macrodef>
	
	<macrodef name="stack-pop">
		<attribute name="stack-name"/>
		<sequential>
			<propertyregex property="@{stack-name}-top" override="true" input="${@{stack-name}-values}" regexp="([^#]*)#.*" select="\1" />
			<propertyregex property="@{stack-name}-values" override="true" input="${@{stack-name}-values}" regexp="[^#]*#(.*)" select="\1" />
		</sequential>
	</macrodef>
	
	<macrodef name="module-stack-init">
		<sequential>
			<stack-init stack-name="modules" initial-value="ROOT"/>
		</sequential>
	</macrodef>
	
    <macrodef name="push-module">
        <attribute name="module-id" />
        <sequential>
        		<stack-push stack-name="modules" value="@{module-id}"/>
        </sequential>
    </macrodef>

    <macrodef name="pop-module">
        <sequential>
        		<stack-pop stack-name="modules" />
        </sequential>
    </macrodef>


	<!-- = = = = = = = = = = = = = = = = =
          macrodef: create-and-copy       
         = = = = = = = = = = = = = = = = = -->
	<macrodef name="create-and-copy">
		<attribute name="dir" />
		<element name="files" implicit="yes" />
		<sequential>
			<mkdir dir="@{dir}" />
			<copy todir="@{dir}">
				<files />
			</copy>
		</sequential>
	</macrodef>

	<!-- = = = = = = = = = = = = = = = = =
          macrodef: create-module-dir         
         = = = = = = = = = = = = = = = = = -->
	<macrodef name="create-module-dir">
		<attribute name="module-id" />
		<attribute name="target-dir" />
		<element name="files" implicit="yes" />
		<sequential>
			<create-and-copy dir="${@{module-id}-basedir}/@{target-dir}">
				<files />
			</create-and-copy>
		</sequential>
	</macrodef>
	
	<!-- = = = = = = = = = = = = = = = = =
          macrodef: dependency-helper          
         = = = = = = = = = = = = = = = = = -->
	<macrodef name="dependency-helper">
		<attribute name="module-id" />
		<attribute name="groupId" />
		<attribute name="artifactId" />
		<attribute name="version" />
		<attribute name="scope" default="compile" />
		<sequential>
			<concat destfile="dependencies.@{module-id}" append="true">
				<filelist dir="${basedir}" files="${template.dir}/dependency.tmpl" />
				<filterchain>
					<replacetokens>
						<token key="dependency.groupId" value="@{groupId}" />
						<token key="dependency.artifactId" value="@{artifactId}" />
						<token key="dependency.version" value="@{version}" />
						<token key="dependency.scope" value="@{scope}" />
					</replacetokens>
				</filterchain>
			</concat>
		</sequential>
	</macrodef>
	
    <!-- = = = = = = = = = = = = = = = = =
          macrodef: create-parent-section          
         = = = = = = = = = = = = = = = = = -->
    <macrodef name="create-parent-section">
        <attribute name="property" />
    	    <attribute name="parent-module-id" />
        <sequential>
			<copy file="${template.dir}/parent.tmpl" tofile="tmp-parent">
				<filterchain>
					<replacetokens>
						<token key="parent.groupId" value="${@{parent-module-id}-groupId}" />
						<token key="parent.artifactId" value="${@{parent-module-id}-artifactId}" />
						<token key="parent.version" value="${@{parent-module-id}-version}" />
					</replacetokens>
				</filterchain>
			</copy>
        		<loadfile property="@{property}" srcfile="tmp-parent"/>
        		<delete file="tmp-parent" />
        </sequential>
    </macrodef>

	<!-- -->
	<macrodef name="dependencies">
		<element name="deps" optional="yes" implicit="true"/>
		<sequential>
			<deps/>
		</sequential>
	</macrodef>

	<!-- use this to define a dependency for this module -->
	<macrodef name="dependency">
		<attribute name="groupId" />
		<attribute name="artifactId" />
		<attribute name="version" />
		<attribute name="scope" default="compile" />
		<sequential>
			<dependency-helper module-id="${modules-top}" groupId="@{groupId}" artifactId="@{artifactId}" version="@{version}" scope="@{scope}"/>
		</sequential>
	</macrodef>

	<!-- this defines a dependency on another opennms module -->
	<macrodef name="module-dependency">
		<attribute name="id" />
		<attribute name="scope" default="compile" />
		<sequential>
			<dependency-helper module-id="${modules-top}" groupId="${@{id}-groupId}" artifactId="${@{id}-artifactId}" version="${@{id}-version}" scope="@{scope}"/>
		</sequential>
	</macrodef>
	
	<!-- this defines the sources that need to be copied for this module -->
	<macrodef name="sources">
		<attribute name="source-type" />
		<element name="filesets" implicit="yes"/>
		<sequential>
			<create-module-dir module-id="${modules-top}" target-dir="${@{source-type}.subdir}">
				<filesets />
			</create-module-dir>
		</sequential>
	</macrodef>
	
	
    <!-- = = = = = = = = = = = = = = = = =
          macrodef: create-empty-module          
         = = = = = = = = = = = = = = = = = -->
    <macrodef name="module">
    		<attribute name="module-id" />
    		<attribute name="module-name" />
    		<attribute name="module-type" />
    		<attribute name="module-packaging" default="jar" />
    		<element name="contents" optional="true" implicit="yes"/>
    		<sequential>
			<module-helper module-id="@{module-id}" module-name="@{module-name}" module-type="@{module-type}" module-packaging="@{module-packaging}" parent-module-id="${modules-top}">
    				<contents/>
    			</module-helper>
        </sequential>
    </macrodef>


	
	<!-- = = = = = = = = = = = = = = = = =
          macrodef: module-helper
          This macro defines a new module that has a pom.xml and other related file
          but no buildable contents.  This is used as a workhorse for other create-XXX-module
          macros that define which also copy files into appropriate locations         
         = = = = = = = = = = = = = = = = = -->
	<macrodef name="module-helper">
		<attribute name="module-id" />
		<attribute name="module-name" />
		<attribute name="module-type" />
		<attribute name="module-packaging" default="jar" />
		<attribute name="pom-template" default="${template.dir}/@{module-type}-pom.tmpl" />
		<attribute name="parent-module-id" default="ROOT" />
		<element name="contents" optional="true" implicit="yes"/>
		<sequential>
			<!-- set up properfies for the module that can be used to set up dependeices in other modules -->
			<property name="@{module-id}-parent" value="@{" />
			<property name="@{module-id}-groupId" value="${@{parent-module-id}-groupId}"/>
			<property name="@{module-id}-artifactId" value="${module.prefix}@{module-id}"/>
			<property name="@{module-id}-version" value="${@{parent-module-id}-version}"/>
			<property name="@{module-id}-basedir" value="${@{parent-module-id}-basedir}/@{module-id}"/>
			
			<push-module module-id="@{module-id}"/>

			<!-- initial the sub modules file for this module -->
			<delete quiet="true" file="modules.@{module-id}" />
			<touch file="modules.@{module-id}"/>

			<!-- initial the dependencies file for this module -->
			<delete quiet="true" file="dependencies.@{module-id}" />
			<touch file="dependencies.@{module-id}" />

			<!-- add the new module to top level project -->
			<add-module-to-parent module-id="@{module-id}" parent-module-id="@{parent-module-id}" />

			<!-- process the contents of the module -->
			<contents />
			
			<create-parent-section property="@{module-id}-parent-section" parent-module-id="@{parent-module-id}" />

			<!-- create the pom.xml file for this module -->
			<!-- first load the dependencies we just created -->
			<loadfile property="dependencies-@{module-id}" srcfile="dependencies.@{module-id}" />

			<!-- now load the submodules for this modules -->
			<loadfile property="modules-@{module-id}" srcfile="modules.@{module-id}" />

			<!-- now copy the pom.xml template to the module dir substiting as necessary -->
			<copy file="@{pom-template}" tofile="${@{module-id}-basedir}/pom.xml">
				<filterchain>
					<replacetokens>
						<token key="module.parent" value="${@{module-id}-parent-section}" />
						<token key="module.artifactId" value="${@{module-id}-artifactId}" />
						<token key="module.name" value="@{module-name}" />
						<token key="module.packaging" value="@{module-packaging}"/>
						<token key="module.dependencies" value="${dependencies-@{module-id}}" />
						<token key="module.modules" value="${modules-@{module-id}}" />
					</replacetokens>
					<tokenfilter>
						<replacestring from="$${dependencies-@{module-id}}" to="" />
						<replacestring from="$${modules-@{module-id}}" to="" />
					</tokenfilter>
				</filterchain>
			</copy>
			<delete file="dependencies.@{module-id}" />
			<delete file="modules.@{module-id}" />

			<!-- now copy any custom resources to the module dir  -->
			<copy failonerror="false" verbose="false" todir="${@{module-id}-basedir}">
				<fileset dir="${module.resources.dir}/@{module-id}">
				</fileset>
			</copy>
			
			<pop-module/>
		</sequential>
	</macrodef>



	<macrodef name="simple-jar-module" description="define a simple jar based module">
		<attribute name="module-id" />
		<attribute name="module-name" />
		<attribute name="src-dir" />
		<element name="contents" implicit="yes" optional="yes" />
		<sequential>
			<module module-id="@{module-id}" module-type="java" module-name="@{module-name}" module-packaging="jar">
				<sources source-type="java">
					<fileset dir="@{src-dir}">
						<include name="**/*.java" />
						<exclude name="**/*Test*.java" />
					</fileset>
				</sources>
				<sources source-type="test">
					<fileset dir="@{src-dir}">
						<include name="**/*Test*.java" />
					</fileset>
				</sources>
				<dependencies>
					<contents />
				</dependencies>
			</module>
		</sequential>
	</macrodef>
	
	<!-- = = = = = = = = = = = = = = = = =
          macrodef: add-module-to-parent          
         = = = = = = = = = = = = = = = = = -->
	<macrodef name="add-module-to-parent">
		<attribute name="module-id" />
		<attribute name="parent-module-id" default="ROOT" />
		<sequential>
			<concat destfile="modules.@{parent-module-id}" append="true">
				<filelist dir="${basedir}" files="${template.dir}/module.tmpl" />
				<filterchain>
					<replacetokens>
						<token key="module.id" value="@{module-id}" />
					</replacetokens>
				</filterchain>
			</concat>
		</sequential>
	</macrodef>

    <!-- = = = = = = = = = = = = = = = = =
          macrodef: create-toplevel-project          
         = = = = = = = = = = = = = = = = = -->
    <macrodef name="toplevel-project">
    		<element name="submodules" implicit="true"/>
        <sequential>
        		<module-stack-init/>
			<module-helper module-id="ROOT" module-name="OpenNMS" module-type="toplevel" module-packaging="pom" parent-module-id="SUPER">
				<submodules/>
			</module-helper>
        		<delete quiet="true" file="modules.SUPER"/>
        </sequential>
    </macrodef>

</project>