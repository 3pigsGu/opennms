
Alarm Notification Feature

Alarms that are generated by the managed devices will be received by openNMS. Alarm notification feature is used to notify other applications about the received alarms. The alarms that are configured in alarmNotificationConf.xml and that match the filter criteria alone will be notified.

Filters

Two types of filters used and are called basic filter and advance filter.

Alarms are filtered based on UEI, device family and severity using basic filter. Out of these, UEI is mandatory and other two are optional.

Further filtering can be done using advance filter with drools.  Advance filtering is optional and if present the alarms that match the advance filtering conditions alone will be notified. 

Script

Notification here actually means invoking the configured script. The script should handle how the alarms should be notified to the application. For example, the received xml can use curl command to post the xml or can store to a database.

Configuration to be done:

Sample notification to be configured in alarmNotificationConf.xml 

Multiple notification tag can be present in alarmNotificationConf.xml. Notification name, script to be invoked, UEI of the alarm to be notified should be configured in alarmNotificationConf.xml. These tags are mandatory.

Script:

If there is no error in the invoked script then exit status is 0. Error handling can be done using errorhandling tag. By default errorhandling is false. If the script sxit status is not .0. or 143, error handling will be done provided it is set to true.

Default timeout for the script invoked is 60 seconds. If the script continues to execute after 60 seconds, alarm notification will not wait for the script status. The timeout can be configured with the attribute called timeout_in_seconds .

The script that is configured should be present in the folder <OPENNMS_HOME>/etc/alarm-notification/scripts

Content of the sample script that posts the received xml to a URL is as follows:

 
Filter:

Basic filter:
Filtering can be done on Severity and Device Family. Supported severities are Indeterminate, Cleared, Normal, Warning, Minor, Major and Critical. Supported device family is present in devicefamily.properties in <OPENNMS_HOME>/etc/alarm-notification.
Advance Filter:
For further filtering, a drl file to be created. The name of the drl file and notification name mentioned in the alarmNotificationConf.xml should match. i.e. For each notification a drl file can be created whose name should match notification name.

Advance filter can be done based on the fields uiclear,alarmid, eventuei,dpname,ipaddr,serviced,reductionkey,alarmtype,counter,severity,firsteventtime,lasteventtime,description,logmsg,operinstruct,tticketid,tticketstate,suppresseduntil,suppresseduser,suppressedtime,alarmackuser,alarmacktime,applicationdn,m_ossprimarykey",x733Alarmtype,x733Probablecause,clearkey, ifindex,eventparms and ifname

Care should be taken while writing the rule. For each rule that satisfies the condition, corresponding script will be invoked. For better performance, multiple rule for same UEI should be avoided.

The drl file should be present in the folder etc/alarm-notification/drools
 
 Sample drl file and sample alarmNotification.xml is provided in directory <OPENNMS_HOME>/etc/examples/alarm-notification.




Alarm dampening:

Alarm notification dampening is done based on alarm counter of the received alarm. Attribute notification_threshold is added for this purpose. Default value will be 5.In this case, 1 st alarm will be notified. Then 6 th alarm will be notified and so on.

Clear Event Notification:

Configuration of clear event is optional. i.e if error event is configured, corresponding clear event will be notified automatically.

But if severity tag is configured for an UEI, then .Normal. and .Cleared. should be added so that clear event and web clear of the alarm will be notified.

 For notification of alarms that are cleared from UI, the event uei.opennms.org/vacuumd/juniper/alarmCleared should be added in eventconf.xml. The event entry is present in etc/examples/alarm-notification/eventconf.xml. This entry should be added to etc/eventconf.xml. DO NOT COPY AND PASTE THE WHOLE FILE. APPEND THE CONTENTS TO ALREADY EXISTING eventconf.xml(if the entry is not present)

Similarly, tags in examples/alarm-notification/vacuumd-configuration.xml should be ADDED in etc/vacuumd-configuration.xml if not present.


      Modification of files after server start:
	
Server restart is NOT required if the configuration change is done when the server is running. Following event to be sent for the changes to be loaded

Go to <OPENNMS_HOME>/bin
./send-event.pl -p 'daemonName Alarmd.AlarmNorthbounder' uei.opennms.org/internal/reloadDaemonConfig

This event will reload the following files 
1.	alarmNotficationConf.xml
2.	drl files
3.	devicefamily.properties



