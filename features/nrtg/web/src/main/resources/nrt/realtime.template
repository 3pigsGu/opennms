<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
        <!-- NRT JavaScript stuff -->        
        <script type="text/javascript" src="/opennms/js/jquery/jquery.js"></script>
        
        <script type="text/javascript" src="/opennms/js/amq_jquery_adapter.js"></script>
        <script type="text/javascript" src="/opennms/js/amq.js"></script>
        
        <script tyep="text/javascript" src="/opennms/js/d3.v2.js"></script>
        <script type="text/javascript" src="/opennms/js/rrdgraph.js"></script>

<style type="text/css">

html, body, div {
  padding: 0;
  margin: 0;
}
</style>

    
<script type="text/javascript">
    

// Eingabe foo Zeug
$(function() {
    
    // Receive inbound JavaScript variables from the controller.
    var collectionTaskId = "${nrtCollectionTaskId}";
    var rrdGraphString = "${rrdGraphString}";

    var metricsMapping = {
        ${metricsMapping}
    };

    // Represents the frequency of data requests.
    var jobPuplishingInterval = 250;
    
    // Create and initialize graph and real time wrapper
    var graphs = RRDGraph.init('.rrdgraph', rrdGraphString);
    var graph = graphs[0];
    
    var dataCollector = new RRDGraph.DataCollector(graph.config, graph.data, metricsMapping);
    
    // Create AMQ object.
    var amq = org.activemq.Amq;

    // Initialize the ActiveMQ listener.
    amq.init({
        uri: '/opennms/amq', 
        logging: true, 
        timeout: 45, 
        clientId:(new Date()).getTime().toString() 
    });
    
    var firstDataSet = true;
    var counterMetrics;
    var counterMetricsValues;
    var counterMetricsTimeStamps;

    amq.addListener('RealtimeHandler', collectionTaskId, function(message) {
        if (message != null) {
// TODO make the json valid to use parseJSON and not eval...
//            var dataSet = $.parseJSON(message.textContent);
            var dataSet = eval(message.textContent);

            // Debug output
            $("#debug_value_count").html(parseInt($("#debug_value_count").html()) + 1);
            
            $("#debug_message_count").html(parseInt($("#debug_message_count").html()) + dataSet.length);
            $("#debug_messages").html(message.textContent);

            dataSet = $.map(dataSet, function(e, i) {
                 temp = {
                    'metricId': e['metricId'],
                    'metricType': e['metricType'],
                    'netInterface': e['netInterface'],
                    'nodeId': e['nodeId'],
                    'service': e['service'],
                    'timeStamp': parseInt(e['timeStamp']),
                    'value': parseInt(e['value'])
                };
                if (temp.metricType == "counter32" || temp.metricType == "counter64") {
                    //first counterMetric ever? Build arrays for merticId and values
                    if(counterMetrics == null) {
                        counterMetrics = new Array();
                        counterMetricsValues = new Array();
                        counterMetricsTimeStamps = new Array();
                        counterMetrics[0] = temp.metricId;
                        counterMetricsValues[0] = temp.value;
                        counterMetricsTimeStamps[0] = temp.timeStamp;
                    } 
                    //there was a counterMetric before, check it metricId is known
                    else {
                        var newMetric = -1;
                        for (var i = 0; i < counterMetrics.length; i++) {
                            if (counterMetrics[i] == temp.metricId) {
                                newMetric = i;
                            }
                        }
                        if (newMetric == -1) {
                            counterMetrics.push(temp.metricId);
                            counterMetricsValues.push(temp.value);
                            counterMetricsTimeStamps.push(temp.timeStamp);
                        }
                        // there is an old value for this counter metric
                        else {
                            var valueDiff = temp.value - counterMetricsValues[newMetric];
                            counterMetricsValues[newMetric] = temp.value;

                            timeDiff = temp.timeStamp - counterMetricsTimeStamps[newMetric];
                            counterMetricsTimeStamps[newMetric] = temp.timeStamp;

                            temp.value = valueDiff * (1000.0 / timeDiff);
                        }
                    }
                }
                return temp;
            });
            //skip pushing the data into the graph for the first dataset with counters
            if (firstDataSet) {
                firstDataSet = false;
                if (counterMetrics != null) {
                    return;
                }
            }
            dataCollector.push(dataSet);   
        }
    });

    // Timer for  AJAX nrtCollectionJobTrigger to republish the CollectionJobCollectionJob
    var refreshTimerJob = {
        /// Submits the AJAX collection job request and requeues the timer.
        submitJob: function() {
            $.get("/opennms/nrt/starter","nrtCollectionTaskId="+collectionTaskId,function(data) { $("#errorDiv").text(data); }, "html");
            this.timeoutID = setTimeout(function(){refreshTimerJob.submitJob()}, this.jobPuplishingInterval);
        },

        /// Used for setting up and starting the refresh timer job.
        setup: function(refreshTicks) {
            this.stop();
            this.jobPuplishingInterval = refreshTicks;
            this.timeoutID = setTimeout(function(){refreshTimerJob.submitJob()}, this.jobPuplishingInterval);
        },

        /// Used for stopping the refresh timer.
        stop: function() {
            if(typeof this.timeoutID == "number") {
                clearTimeout(this.timeoutID);
                delete this.timeoutID;
            }
        }
    };
    
    // Set up the input box that allows us to adjust the interval in which data points are graphed.
    $('#jobPuplishingInterval').val(jobPuplishingInterval);
    $('#jobPuplishingInterval').bind('change', function() {
        jobPuplishingInterval = $(this).val();
        refreshTimerJob.setup(jobPuplishingInterval);
    });
    
    // Start the AJAX job timer.
    refreshTimerJob.setup(jobPuplishingInterval);
});
</script>

</head>
       
<body>        
    <div id="main"></div>
    <center>
        <div class="rrdgraph" data-src="realtime=1"></div>
    </center>
<!--
    <div>Refresh Interval (in ms)<input id="jobPuplishingInterval" name="jobPuplishingInterval"></input></div>
    <div>Graph Duration (in seconds)<input id="durationInterval" name="durationInterval"></input></div>
    <div id="errorDiv"></div>
    <div id="debug_rrd_string"><pre>$ {rrdGraphString}</pre></div>
    <div id="debug_value_count">0</div>
    <div id="debug_message_count">0</div>
    <div id="debug_messages">No Message jet</div>  
-->
</body>
